<html><head><title>JS13K 2024: Superfright</title><script src=https://js13kgames.com/webxr-src/2024/aframe.js></script><script>(()=>{var t,e=[];window.DEBUG={...window.DEBUG,log(){setTimeout((()=>{for(console.log(...arguments),e.push([...arguments].join(" "));e.length>5;)e.shift();t.setAttribute("value",e.join("\n"))}),100)}},AFRAME.registerComponent("debug-console",{sceneOnly:!0,init(){(t=document.createElement("a-text")).setAttribute("align","left"),t.setAttribute("font","monoid"),t.setAttribute("color","black"),t.setAttribute("position","-2.25 -0.25 -3.5"),document.querySelector("a-camera").appendChild(t)}});var i=(t,e,i,o)=>{setTimeout((()=>{const i=document.querySelector(t);i.components["gesture-tracker"].target=document.querySelector(`${e} a-${o}`),i.addState("hovering-"+o),i.addState("grabbing")}),i)};function o(t){return new THREE.Vector3(t.x,t.y,t.z)}window.DEBUG={...window.DEBUG,grabGun(t,e,o){i(t,e,o,"gun")},grabPortal(t,e,o){i(t,e,o,"portal")},drop(t,e){setTimeout((()=>{document.querySelector(t).removeState("grabbing")}),e)},loadLevel(t,e){setTimeout((()=>{document.querySelector("a-scene").emit("load-level",{levelId:t})}),e)}},AFRAME.registerPrimitive("a-gun",{defaultComponents:{gun:{},"dynamic-collider":{size:.1}},mapping:{pointDown:"gun.pointDown"}}),AFRAME.registerComponent("gun",{schema:{pointDown:{type:"boolean",default:!1}},init(){this.gimbal=document.createElement("a-entity"),this.gimbal.object3D.rotation.x=this.data.pointDown?-Math.PI/2:0;const t=document.createElement("a-box");t.setAttribute("color","#000"),t.setAttribute("depth",.2),t.setAttribute("height",.08),t.setAttribute("width",.04),t.object3D.position.y=.06,t.object3D.position.z=-.08,this.gimbal.appendChild(t);const e=document.createElement("a-box");e.setAttribute("color","#000"),e.setAttribute("depth",.08),e.setAttribute("height",.16),e.setAttribute("width",.04),e.object3D.rotation.x=-Math.PI/8,this.gimbal.appendChild(e),this.el.appendChild(this.gimbal)},update(){this.gimbal.object3D.rotation.x=this.data.pointDown?-Math.PI/2:0}}),AFRAME.registerPrimitive("a-portal",{defaultComponents:{portal:{},geometry:{primitive:"cone",thetaStart:45,segmentsRadial:4,segmentsHeight:1,radiusTop:0,radiusBottom:.2,height:.175},material:{color:"black",opacity:.45},"dynamic-collider":{size:.15}},mappings:{to:"portal.to","text-value":"portal.textValue","text-width":"portal.textWidth"}}),AFRAME.registerComponent("portal",{schema:{to:{type:"string"},textValue:{type:"string"},textWidth:{type:"number"}},init(){const t=this.data,e=document.createElement("a-entity");e.setAttribute("text",{value:t.textValue,align:"center",font:"monoid",width:t.textWidth}),e.setAttribute("position",{x:0,y:-.04,z:.05}),this.el.appendChild(e)}}),AFRAME.registerPrimitive("a-pyramid",{defaultComponents:{geometry:{primitive:"cone",thetaStart:45,segmentsRadial:4,segmentsHeight:1,radiusTop:0}},mappings:{color:"material.color",height:"geometry.height",width:"geometry.radiusBottom"}}),AFRAME.registerComponent("dynamic-collider",{schema:{size:{type:"number",default:0}},_play(){this.el.setAttribute("obb-collider",{size:this.data.size})},_pause(){this.el.removeAttribute("obb-collider")}}),AFRAME.registerComponent("game-time",{schema:{type:"number",default:0},init(){this.format=new Intl.NumberFormat(navigator.language,{minimumFractionDigits:2,maximumFractionDigits:2}).format},update(){this.el.setAttribute("value",this.format(this.data/1e3)+"s")}}),AFRAME.registerComponent("gravity",{schema:{type:"boolean",default:!1}}),AFRAME.registerComponent("gesture-tracker",{dependencies:["hand-controls","obb-collider"],events:{gripdown(){this.el.addState("grabbing")},gripup(){this.el.removeState("grabbing")},triggerdown(){this.el.addState("shooting")},triggerup(){this.el.removeState("shooting")},obbcollisionstarted(t){this.target=t.detail.withEl,this.target.components.portal?this.el.addState("hovering-portal"):this.target.components.gun&&this.el.addState("hovering-gun")},obbcollisionended(){this.target?.components.portal?this.el.removeState("hovering-portal"):this.target?.components.gun&&this.el.removeState("hovering-gun"),this.target=null}},reset(){this.target=null,this.el.removeState("holding-gun"),this.el.removeState("hovering-gun"),this.el.removeState("hovering-portal")}}),AFRAME.registerComponent("level",{dependencies:["visible"],schema:{active:{type:"boolean",default:!1},gameTimeTracked:{type:"boolean",default:!1}},update(){this.el.object3D.visible=this.data.active,this.el[this.data.active?"play":"pause"]();for(const t of document.querySelectorAll(`#${this.el.id} [dynamic-collider]`))t.components["dynamic-collider"][this.data.active?"_play":"_pause"]()}}),AFRAME.registerComponent("motion-tracker",{init(){this.prevPos=this.el.object3D.position.clone(),this.prevRot=o(this.el.object3D.rotation)},tick(){if(this.prevPos.distanceToSquared(this.el.object3D.position)>.001)this.prevPos=this.el.object3D.position.clone(),this.el.addState("player-moving");else{const t=o(this.el.object3D.rotation);this.prevRot.distanceToSquared(t)>1e-4?(this.prevRot=t,this.el.addState("player-moving")):this.el.removeState("player-moving")}}}),AFRAME.registerComponent("puppet",{}),AFRAME.registerComponent("sync-stance",{schema:{src:{type:"string"}},init(){this.src=document.querySelector(this.data.src)},tick(){this.el.isPlaying&&this.src&&(this.el.object3D.position.x=this.src.object3D.position.x,this.el.object3D.position.y=this.src.object3D.position.y,this.el.object3D.position.z=this.src.object3D.position.z,this.el.object3D.rotation.x=this.src.object3D.rotation.x,this.el.object3D.rotation.y=this.src.object3D.rotation.y,this.el.object3D.rotation.z=this.src.object3D.rotation.z)}}),AFRAME.registerSystem("game-time",{schema:{type:"number",default:0},init(){this.playerLimbs=document.querySelectorAll("[motion-tracker]"),this.gameTimeHUD=document.querySelector("[game-time]");const t=this.el;t.addEventListener("level-loaded",(()=>{this.toggleGameTimeHUDVisibility(t.is("game-time-tracked"))}))},tick(t,e){const i=this.el;if(i.is("game-time-tracked"))for(limb of this.playerLimbs)if(limb.is("player-moving")){this.data+=e,this.gameTimeHUD.setAttribute("game-time",this.data),i.emit("step",{time:this.data,timeDelta:e});break}},toggleGameTimeHUDVisibility(t){this.gameTimeHUD.object3D.visible=t}}),AFRAME.registerSystem("gesture-tracker",{init(){this.hands=document.querySelectorAll("[gesture-tracker]")},tick(){for(const t of this.hands){const e=t.components["gesture-tracker"].target;t.is("hovering-portal")&&t.is("grabbing")?(t.removeState("hovering-portal"),t.removeState("grabbing"),this.el.emit("load-level",{levelId:e.getAttribute("portal").to})):t.is("hovering-gun")&&t.is("grabbing")?(t.removeState("hovering-gun"),t.addState("holding-gun"),this.grabGun(e,t)):t.is("holding-gun")&&!t.is("grabbing")&&(t.removeState("holding-gun"),t.addState("hovering-gun"),this.dropGun(e))}},grabGun(t,e){t.setAttribute("sync-stance",{src:"#"+e.id}),t.setAttribute("gun",{pointDown:!0}),t.setAttribute("gravity",!1)},dropGun(t){t.removeAttribute("sync-stance"),t.setAttribute("gravity",!0)}}),AFRAME.registerSystem("puppeteer",{init(){this.el.addEventListener("step",(t=>this.step(t.detail.time,t.detail.timeDelta))),this.puppets=document.querySelectorAll("[puppet]"),this.gravitas=document.querySelectorAll("[gravity]")},step(t,e){for(let e of this.puppets){const i=Math.sin(t/1e3);e.object3D.position.x=2*i,e.object3D.rotation.z=-i}for(let t of this.gravitas)t.getAttribute("gravity")&&(t.object3D.position.y=Math.max(0,t.object3D.position.y-.98/3*e/1e3))}}),AFRAME.registerSystem("conductor",{init(){this.hands=document.querySelectorAll("[gesture-tracker]"),this.el.addEventListener("load-level",(t=>this.loadLevel(t.detail.levelId))),this.loadLevel("#title"),DEBUG.loadLevel("#level_1",0),DEBUG.grabGun("#leftHand","#level_1",500),DEBUG.grabPortal("#rightHand","#level_1",1e3),DEBUG.drop("#leftHand",1500),DEBUG.log("foo")},loadLevel(t){let e=this.activeLevel;e&&this.toggleLevel(e,!1),e=document.querySelector(t),this.toggleLevel(e,!0),this.activeLevel=e,this.hands.forEach((t=>{t.components["gesture-tracker"]?.reset()})),this.el.emit("level-loaded",{level:e})},toggleLevel(t,e){t.setAttribute("level",{active:e});const i=this.el;i[e?"addState":"removeState"](t.id),i[t.getAttribute("level").gameTimeTracked?"addState":"removeState"]("game-time-tracked")}})})();</script></head><body><a-scene obb-collider="showColliders: false"><a-entity id=title level><a-text value=SuperFRIGHT align=center color=white font=monoid width=20 position="0 3 -5"></a-text><a-portal to=#level_1 text-value=GRAB text-width=1.75 position="0 1.5 -0.5"></a-portal></a-entity><a-entity id=level_1 level="gameTimeTracked: true"><a-gun gravity position="0 1.6 -0.5"></a-gun><a-cylinder id=puppet_1 puppet position="0 1 -4" radius=0.5 height=2 color=#FFC65D><a-sphere position="0 0.5 0.5" radius=0.25 color=#EF2D5E></a-sphere></a-cylinder><a-plane position="0 0 -3" rotation="-90 0 0" width=5 height=5 color=#7BC8A4></a-plane><a-portal to=#level_2 text-value="Level 2" text-width=1.75 position="0.25 1.5 -0.5"></a-portal></a-entity><a-entity id=level_2 level="gameTimeTracked: true"><a-gun gravity position="0.25 1.6 -0.5"></a-gun><a-plane position="0 0 -3" rotation="-90 0 0" width=5 height=5 color=blue></a-plane><a-portal to=#title text-value=Title text-width=1.75 position="0 1.5 -0.5"></a-portal></a-entity><a-sky color=#ddd></a-sky><a-camera motion-tracker><a-text value=0.00s align=center color=black font=monoid position="0 0.65 -1.5" game-time></a-text></a-camera><a-entity id=leftHand hand-controls="hand: left; handModelStyle: toon" obb-collider="size: 0.1 0.1 0.1" position="-0.25 1.6 0" motion-tracker gesture-tracker></a-entity><a-entity id=rightHand hand-controls="hand: right; handModelStyle: toon" obb-collider="size: 0.1 0.1 0.1" position="0.25 1.6 0" motion-tracker gesture-tracker></a-entity></a-scene></body></html>