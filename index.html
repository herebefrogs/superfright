<html><head><title>JS13K 2024: SuperFIGHT VR</title><script src=https://js13kgames.com/webxr-src/2024/aframe.js></script><script>(()=>{var t,e=[];window.DEBUG={...window.DEBUG,log(){setTimeout((()=>{for(console.log(...arguments),e.push([...arguments].map((t=>JSON.stringify(t))).join(" "));e.length>5;)e.shift();t?.setAttribute("value",e.join("\n"))}),100)}},AFRAME.registerComponent("debug-console",{sceneOnly:!0,init(){(t=document.createElement("a-text")).setAttribute("align","left"),t.setAttribute("font","monoid"),t.setAttribute("color","black"),t.setAttribute("position","-2.25 -0.25 -3.5"),document.querySelector("a-camera").appendChild(t)}});var i=(t,e,i,o)=>{setTimeout((()=>{const i=document.querySelector(t);i.components["gesture-tracker"].targets["hovering-"+o]=document.querySelector(`${e} a-${o}`),i.addState("hovering-"+o),i.addState("grabbing")}),i)};function o(t){return new THREE.Vector3(t.x,t.y,t.z)}window.DEBUG={...window.DEBUG,grabGun(t,e,o){i(t,e,o,"gun")},grabPortal(t,e,o){i(t,e,o,"portal")},drop(t,e){setTimeout((()=>{document.querySelector(t).removeState("grabbing")}),e)},move(t,e,i){setTimeout((()=>{document.querySelector(t).setAttribute("position",e)}),i)},buttonEvent(t,e,i){setTimeout((()=>{document.querySelector(t).emit(e)}),i)},loadLevel(t,e){setTimeout((()=>{document.querySelector("a-scene").emit("loadlevel",{levelId:t})}),e)}},AFRAME.registerPrimitive("a-bullet",{defaultComponents:{bullet:{},"dynamic-collider":{on:!0},"linear-motion":{speed:1.5},ttl:5},mappings:{direction:"linear-motion.direction"}}),AFRAME.registerComponent("bullet",{events:{componentchanged(t){"linear-motion"===t.detail.name&&this.updateTrail(this.el.getAttribute("linear-motion").distanceTravelled)},ttlreached(t){this.removeBullet(t.detail.el)},obbcollisionstarted(t){const e=t.detail.withEl;e.components.health&&this.el.components.health.data.group!==e.components.health.data.group&&(e.setAttribute("health",{hp:0}),this.el.setAttribute("health",{hp:0}))}},init(){const t=this.el.sceneEl.is("vr-mode"),e=document.createElement("a-entity");e.setAttribute("geometry",{primitive:"cylinder",radius:.01,height:.04,segmentsRadial:6,segmentsHeight:1,openEnded:!1}),e.setAttribute("material",{color:"black"}),e.setAttribute("rotation",{x:t?0:90});const i=document.createElement("a-entity");i.setAttribute("line",{color:"black",opacity:.15,start:"0 0 0",end:"0 0 0"}),i.setAttribute("rotation",{x:-90}),e.appendChild(i),this.trail=i,this.el.appendChild(e)},updateTrail(t){t>2||this.trail.setAttribute("line",{end:"0 0 "+t})},removeBullet(t){t.parentNode.removeChild(t),t.destroy()}}),AFRAME.registerPrimitive("a-gun",{defaultComponents:{gun:{},"dynamic-collider":{size:.1},raycaster:{enabled:!1,objects:"#world"}},mapping:{pointDown:"gun.pointDown"}}),AFRAME.registerComponent("gun",{schema:{pointDown:{type:"boolean",default:!1}},init(){this.gimbal=document.createElement("a-entity"),this.gimbal.object3D.rotation.x=this.data.pointDown?-Math.PI/2:0;const t=document.createElement("a-box");t.setAttribute("color","#000"),t.setAttribute("depth",.2),t.setAttribute("height",.08),t.setAttribute("width",.04),t.object3D.position.y=.06,t.object3D.position.z=-.08,this.gimbal.appendChild(t);const e=document.createElement("a-box");e.setAttribute("color","#000"),e.setAttribute("depth",.08),e.setAttribute("height",.16),e.setAttribute("width",.04),e.object3D.rotation.x=-Math.PI/8,this.gimbal.appendChild(e),this.el.appendChild(this.gimbal)},update(){this.gimbal.object3D.rotation.x=this.data.pointDown?-Math.PI/2:0,this.el.setAttribute("raycaster",this.data.pointDown?{direction:"0 -1 0",origin:"0 -0.2 -0.08"}:{direction:"0 0 -1",origin:"0 0.09 -0.2"})}}),AFRAME.registerPrimitive("a-portal",{defaultComponents:{portal:{},geometry:{primitive:"cone",thetaStart:45,segmentsRadial:4,segmentsHeight:1,radiusTop:0,radiusBottom:.2,height:.175},material:{color:"black",opacity:.45},"dynamic-collider":{size:.15}},mappings:{to:"portal.to","text-value":"portal.textValue","text-width":"portal.textWidth"}}),AFRAME.registerComponent("portal",{schema:{to:{type:"string"},textValue:{type:"string"},textWidth:{type:"number"}},init(){const t=this.data,e=document.createElement("a-entity");e.setAttribute("text",{value:t.textValue,align:"center",font:"monoid",width:t.textWidth}),e.setAttribute("position",{x:0,y:-.04,z:.05}),this.el.appendChild(e)}}),AFRAME.registerPrimitive("a-pyramid",{defaultComponents:{geometry:{primitive:"cone",thetaStart:45,segmentsRadial:4,segmentsHeight:1,radiusTop:0}},mappings:{color:"material.color",height:"geometry.height",width:"geometry.radiusBottom"}}),AFRAME.registerComponent("dynamic-collider",{schema:{size:{type:"number",default:0},on:{type:"boolean",default:!1}},init(){this.data.on&&this._play()},_play(){this.el.setAttribute("obb-collider",{size:this.data.size})},_pause(){this.el.removeAttribute("obb-collider")}}),AFRAME.registerComponent("game-time",{schema:{type:"number",default:0},init(){this.format=new Intl.NumberFormat(navigator.language,{minimumFractionDigits:2,maximumFractionDigits:2}).format},update(){this.el.setAttribute("value",this.format(this.data)+"s")}}),AFRAME.registerComponent("gravity",{schema:{type:"boolean",default:!1}}),AFRAME.registerComponent("gesture-tracker",{dependencies:["hand-controls","obb-collider"],events:{gripdown(){this.el.addState("grabbing")},gripup(){this.el.removeState("grabbing")},triggerdown(){this.el.addState("shooting")},triggerup(){this.el.removeState("shooting")},obbcollisionstarted(t){const e=t.detail.withEl;e.components["gesture-tracker"]||(e.components.portal?(this.el.addState("hovering-portal"),this.targets["hovering-portal"]=e):e.components.gun&&(this.el.addState("hovering-gun"),this.targets["hovering-gun"]=e))},obbcollisionended(t){const e=t.detail.withEl;e.components["gesture-tracker"]||(e.components.portal?(this.el.removeState("hovering-portal"),delete this.targets["hovering-portal"]):e.components.gun&&(this.el.removeState("hovering-gun"),delete this.targets["hovering-gun"]))}},init(){this.targets={}},getTarget(t){return this.targets[t]},updateTarget(t,e){return this.targets[e]=this.targets[t],delete this.targets[t],this.targets[e]},reset(){for(state in this.targets)this.targets[state].removeState("grabbed");this.targets={},this.el.removeState("holding-gun"),this.el.removeState("hovering-gun"),this.el.removeState("hovering-portal")}}),AFRAME.registerComponent("health",{schema:{hp:{type:"int",default:1},group:{type:"string",default:"foe"}},update(){this.data.hp>0||this.el.parentNode.removeChild(this.el)}}),AFRAME.registerComponent("level",{dependencies:["visible"],schema:{active:{type:"boolean",default:!1},gameTimeTracked:{type:"boolean",default:!1}},update(){this.el.object3D.visible=this.data.active,this.el[this.data.active?"play":"pause"]();for(const t of document.querySelectorAll(`#${this.el.id} [dynamic-collider]`))t.components["dynamic-collider"][this.data.active?"_play":"_pause"]()}}),AFRAME.registerComponent("linear-motion",{schema:{direction:{type:"vec3",default:"0 0 0"},speed:{type:"number",default:1},distanceTravelled:{type:"number",default:0}}}),AFRAME.registerComponent("motion-tracker",{init(){this.prevPos=this.el.object3D.position.clone(),this.prevRot=o(this.el.object3D.rotation)},tick(){if(this.prevPos.distanceToSquared(this.el.object3D.position)>.001)this.prevPos=this.el.object3D.position.clone(),this.el.addState("player-moving");else{const t=o(this.el.object3D.rotation);this.prevRot.distanceToSquared(t)>1e-4?(this.prevRot=t,this.el.addState("player-moving")):this.el.removeState("player-moving")}}}),AFRAME.registerComponent("puppet",{}),AFRAME.registerComponent("sync-stance",{schema:{src:{type:"string"}},init(){this.src=document.querySelector(this.data.src)},tick(){this.el.isPlaying&&this.src&&(this.el.object3D.position.x=this.src.object3D.position.x,this.el.object3D.position.y=this.src.object3D.position.y,this.el.object3D.position.z=this.src.object3D.position.z,this.el.object3D.rotation.x=this.src.object3D.rotation.x,this.el.object3D.rotation.y=this.src.object3D.rotation.y,this.el.object3D.rotation.z=this.src.object3D.rotation.z)}}),AFRAME.registerComponent("ttl",{schema:{type:"number",default:10},init(){this.timeLeft=this.data,this.el.sceneEl.addEventListener("tick",(t=>this._tick(t.detail.time,t.detail.timeDelta)))},_tick(t,e){this.timeLeft-=e,0>this.timeLeft&&(this.el.removeAttribute("ttl"),this.el.emit("ttlreached",{el:this.el}))}}),AFRAME.registerSystem("game-time",{schema:{type:"number",default:0},init(){this.playerLimbs=document.querySelectorAll("[motion-tracker]"),this.gameTimeHUD=document.querySelector("[game-time]");const t=this.el;t.addEventListener("level-loaded",(()=>{this.toggleGameTimeHUDVisibility(t.is("game-time-tracked"))}))},tick(t,e){const i=this.el;if(i.is("game-time-tracked"))for(limb of(e/=1e3,this.playerLimbs))if(limb.is("player-moving")){this.data+=e,this.gameTimeHUD.setAttribute("game-time",this.data),i.emit("tick",{time:this.data,timeDelta:e});break}},toggleGameTimeHUDVisibility(t){this.gameTimeHUD.object3D.visible=t}}),AFRAME.registerSystem("gesture-tracker",{init(){this.hands=document.querySelectorAll("[gesture-tracker]")},tick(){for(const t of this.hands){const e=t.components["gesture-tracker"];t.is("hovering-portal")&&t.is("grabbing")?(t.removeState("hovering-portal"),t.removeState("grabbing"),this.el.emit("loadlevel",{levelId:e.getTarget("hovering-portal").components.portal.data.to})):t.is("hovering-gun")&&t.is("grabbing")&&!e.getTarget("hovering-gun").is("grabbed")?(t.removeState("hovering-gun"),t.addState("holding-gun"),this.grabGun(e.updateTarget("hovering-gun","holding-gun"),t)):t.is("holding-gun")&&!t.is("grabbing")?(t.removeState("holding-gun"),t.addState("hovering-gun"),this.dropGun(e.updateTarget("holding-gun","hovering-gun"))):t.is("holding-gun")&&t.is("shooting")&&(t.removeState("shooting"),this.shootGun(e.getTarget("holding-gun")))}},grabGun(t,e){t.addState("grabbed"),t.setAttribute("sync-stance",{src:"#"+e.id}),t.setAttribute("gun",{pointDown:this.el.is("vr-mode")}),t.setAttribute("raycaster",{enabled:!0}),t.setAttribute("gravity",!1)},dropGun(t){t.removeState("grabbed"),t.removeAttribute("sync-stance"),t.setAttribute("raycaster",{enabled:!1}),t.setAttribute("gravity",!0)},shootGun(t){if(t.components.raycaster.data.enabled){const e=document.querySelector("#world"),i=t.components.raycaster.getIntersection(e).normal,o={x:-i.x,y:-i.y,z:-i.z},r=document.createElement("a-bullet"),a=t.getAttribute("position"),s=t.getAttribute("rotation");r.setAttribute("position",`${a.x} ${a.y+.08} ${a.z-.22}`),r.setAttribute("rotation",`${s.x} ${s.y} ${s.z}`),r.setAttribute("linear-motion",{direction:`${o.x} ${o.y} ${o.z}`}),r.setAttribute("health",{group:t.components.health.data.group}),this.el.systems.level.activeLevel.appendChild(r)}}});var r=.98/3;AFRAME.registerSystem("puppeteer",{init(){this.el.addEventListener("tick",(t=>this._tick(t.detail.time,t.detail.timeDelta))),this.el.addEventListener("child-attached",(t=>{this.trackEntity(t.detail.el)})),this.el.addEventListener("child-detached",(t=>{this.untrackEntity(t.detail.el)}))},_tick(t,e){for(let t of this.gravitas)t.getAttribute("gravity")&&t.object3D.position.y>.25&&(t.object3D.position.y=Math.max(.25,t.object3D.position.y-r*e));for(let t of this.linearMovers){const i=t.components["linear-motion"],o=i.data.speed*e,r=i.data.direction.x*o,a=i.data.direction.y*o,s=i.data.direction.z*o;t.object3D.position.x+=r,t.object3D.position.y+=a,t.object3D.position.z+=s,t.setAttribute("linear-motion",{distanceTravelled:i.data.distanceTravelled+Math.sqrt(r*r+a*a+s*s)})}},reset(){this.linearMovers=[...document.querySelectorAll(`#${this.el.systems.level.activeLevel?.id} [linear-motion]`)],this.gravitas=[...document.querySelectorAll(`#${this.el.systems.level.activeLevel?.id} [gravity]`)]},trackEntity(t){t.components["linear-motion"]&&this.linearMovers.push(t),t.components.gravity&&this.gravitas.push(t)},untrackEntity(t){t.components["linear-motion"]&&(this.linearMovers=this.linearMovers.filter((e=>e!==t))),t.components.gravity&&(this.gravitas=this.gravitas.filter((e=>e!==t)))}}),AFRAME.registerSystem("level",{init(){this.hands=document.querySelectorAll("[gesture-tracker]");const t=this.el;t.addEventListener("loadlevel",(t=>this.loadLevel(t.detail.levelId))),t.addEventListener("loaded",(()=>{this.loadLevel("#title")}))},loadLevel(t){let e=this.activeLevel;e&&this.toggleLevel(e,!1),e=document.querySelector(t),this.toggleLevel(e,!0),this.activeLevel=e,this.hands.forEach((t=>{t.components["gesture-tracker"]?.reset()})),this.el.systems.puppeteer.reset(),this.el.emit("level-loaded",{level:e})},toggleLevel(t,e){t.setAttribute("level",{active:e});const i=this.el;i[e?"addState":"removeState"](t.id),i[t.getAttribute("level").gameTimeTracked?"addState":"removeState"]("game-time-tracked")}})})();</script></head><body><a-scene obb-collider="showColliders: false" debug-console><a-entity id=title level><a-text value="SuperFRIGHT VR" align=center color=#e26 font=monoid width=20 position="0 3 -5"></a-text><a-text value="13 seconds to beat 13 enemies" align=center color=black font=monoid width=5 height=2 position="0 1.8 -5"></a-text><a-portal to=#level_1 text-value=GRAB text-width=1.75 position="0 1.2 -0.5"></a-portal></a-entity><a-entity id=level_1 level="gameTimeTracked: true"><a-gun gravity position="-0.75 1.1 -0.5" health="group: friend"></a-gun><a-cone id=puppet_1 position="0 1 -5" radius-bottom=0.2 radius-top=0.4 segments-radial=6 segments-height=1 color=#e26 material="shader: phong" linear-motion="direction: 0 0 1; speed: 0.75" health="group: foe" dynamic-collider><a-dodecahedron position="0 0.75 0.15" radius=0.25 color=#EF2D5E></a-dodecahedron><a-pyramid position="0.40 0.15 0.4" rotation="115 35 10" scale="0.25 0.75 0.25" color=#EF2D5E></a-pyramid><a-pyramid position="-0.40 0.15 0.4" rotation="115 -25 0" scale="0.25 0.75 0.25" color=#EF2D5E></a-pyramid></a-cone><a-portal to=#level_2 text-value="Level 2" text-width=1.75 position="0.75 1.2 -0.5" visible=false></a-portal><a-cylinder id=room1 radius=3 height=30 segments-radial=3 segments-height=1 geometry="openEnded: true" material="shader: phong; color: #ddd; side: back" position="0 1.5 0" rotation="-90 0 0"></a-cylinder><a-box id=table1 width=3 depth=1 height=1.5 color=#f8fbfe position="-2 0 -1"></a-box><a-box id=table2 width=3 depth=1 height=1.5 color=#f8fbfe position="2 0 -1"></a-box></a-entity><a-entity id=level_2 level="gameTimeTracked: true"><a-gun gravity position="0 1.5 -0.5" health="group: friend"></a-gun><a-plane position="0 0 -3" rotation="-90 0 0" width=5 height=5 color=blue></a-plane><a-portal to=#title text-value=Title text-width=1.75 position="-0.5 1.2 -0.5"></a-portal></a-entity><a-sky color=#dff></a-sky><a-sphere id=world color=blue radius=1000 material="shader: flat; wireframe: true; side: back"></a-sphere><a-camera motion-tracker><a-text value=0.00s align=center color=black font=monoid position="0 0.65 -1.5" game-time></a-text><a-box id=player height=1.8 width=0.5 depth=0.3 position="0 0.9 0.35" obb-collider health="group: friend"></a-box></a-camera><a-entity id=left hand-controls="hand: left; handModelStyle: toon" position="-0.5 1 0" health="group: friend" obb-collider="size: 0.1" motion-tracker gesture-tracker></a-entity><a-entity id=right hand-controls="hand: right; handModelStyle: toon" position="0.5 1 0" health="group: friend" obb-collider="size: 0.1" motion-tracker gesture-tracker></a-entity></a-scene></body></html>